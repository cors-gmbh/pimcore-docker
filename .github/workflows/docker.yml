name: CORS Pimcore Docker Build

on:
  push:
    branches:
      - "7.0" # Triggers for branch pushes for latest builds
    tags:
      - "*"   # Triggers for tag pushes for release builds
  pull_request: # Triggers for PR builds (latest)
  workflow_dispatch: # Allows manual trigger with workflow_dispatch

jobs:
  build_php:
    uses: ./.github/workflows/docker-build.yml
    with:
      component: php
      matrix: |
        {
          "arch": ["amd", "arm"],
          "php_version": ["8.2", "8.3"],
          "php_type": ["fpm", "cli"],
          "alpine": ["3.20", "3.21"]
        }
      matrix_manifest: |
        {
          "php_version": ["8.2", "8.3"],
          "php_type": ["fpm", "cli"],
          "alpine": ["3.20", "3.21"]
        }
      release_tag: ${{ github.event_name == 'push' && github.event.ref_type == 'tag' && github.ref_name || github.ref_name + '-LATEST' }}

  build_php_debug:
    uses: ./.github/workflows/docker-build.yml
    needs: build_php
    with:
      component: php-debug
      matrix: |
        {
          "arch": ["amd", "arm"],
          "php_version": ["8.2", "8.3"],
          "php_type": ["fpm"],
          "alpine": ["3.20", "3.21"]
        }
      matrix_manifest: |
        {
          "php_version": ["8.2", "8.3"],
          "php_type": ["fpm"],
          "alpine": ["3.20", "3.21"]
        }
      release_tag: ${{ github.event_name == 'push' && github.event.ref_type == 'tag' && github.ref_name || github.ref_name + '-LATEST' }}

  build_php_blackfire:
    uses: ./.github/workflows/docker-build.yml
    needs: build_php
    with:
      component: php-blackfire
      matrix: |
        {
          "arch": ["amd", "arm"],
          "php_version": ["8.2", "8.3"],
          "alpine": ["3.20", "3.21"]
        }
      matrix_manifest: |
        {
          "php_version": ["8.2", "8.3"],
          "alpine": ["3.20", "3.21"]
        }
      release_tag: ${{ github.event_name == 'push' && github.event.ref_type == 'tag' && github.ref_name || github.ref_name + '-LATEST' }}

  build_supervisord:
    uses: ./.github/workflows/docker-build.yml
    needs: build_php
    with:
      component: supervisord
      matrix: |
        {
          "arch": ["amd", "arm"],
          "php_version": ["8.2", "8.3"],
          "alpine": ["3.20", "3.21"]
        }
      matrix_manifest: |
        {
          "php_version": ["8.2", "8.3"],
          "alpine": ["3.20", "3.21"]
        }
      release_tag: ${{ github.event_name == 'push' && github.event.ref_type == 'tag' && github.ref_name || github.ref_name + '-LATEST' }}

  build_nginx:
    uses: ./.github/workflows/docker-build.yml
    with:
      component: nginx
      matrix: |
        {
          "arch": ["amd", "arm"],
          "nginx_version": ["1.25", "1.26"]
        }
      matrix_manifest: |
        {
          "nginx_version": ["1.25", "1.26"]
        }
      release_tag: ${{ github.event_name == 'push' && github.event.ref_type == 'tag' && github.ref_name || github.ref_name + '-LATEST' }}